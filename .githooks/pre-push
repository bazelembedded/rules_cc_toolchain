#!/usr/bin/env bash
set -e -o pipefail

echo "Test compiler against well known repos."

TARGETS='@com_google_googletest//... @com_github_google_benchmark//... @com_google_absl//... @com_google_protobuf//:protoc'
STATIC_ANALYZER_TARGETS='@com_google_protobuf//:protoc'

# Test compilation of well known repositories
bazel test $TARGETS --test_tag_filters=-benchmark

bazel build $TARGETS

bazel build $STATIC_ANALYZER_TARGETS --aspects //tools/clang_tidy:clang_tidy.bzl%clang_tidy_aspect --output_groups=report 

echo "Test compiler agains well known ARM embedded repos."

bazel build @com_github_stmicroelectronics_stm32cubel4//:stm32l4xx_hal_driver @com_github_stmicroelectronics_stm32cubel4//:stm32_cmsis_driver --platforms=//tests:stm32l432xx